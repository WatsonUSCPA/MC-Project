{"ast":null,"code":"var _jsxFileName = \"C:\\\\Users\\\\what1\\\\OneDrive\\\\Desktop\\\\Project\\\\MCProject_Beta\\\\mc-square-react\\\\src\\\\Success.tsx\",\n  _s = $RefreshSig$();\nimport React, { useEffect } from 'react';\nimport { useCart } from './CartContext';\nimport { getAuth, onAuthStateChanged } from 'firebase/auth';\nimport { getFirestore, doc, getDoc, updateDoc } from 'firebase/firestore';\nimport { app } from './firebase';\nimport { jsxDEV as _jsxDEV } from \"react/jsx-dev-runtime\";\nconst db = getFirestore(app);\nconst auth = getAuth(app);\nconst Success = () => {\n  _s();\n  const {\n    clearCart\n  } = useCart();\n  useEffect(() => {\n    // カート内容をlocalStorageから取得\n    let cartItems = [];\n    try {\n      const cartStr = localStorage.getItem('mcSquareCart');\n      if (cartStr) cartItems = JSON.parse(cartStr);\n    } catch {}\n    clearCart();\n    // 決済金額からポイント付与・購入履歴追加\n    const grantPointsAndSaveOrder = async user => {\n      if (!user) return;\n      try {\n        const userRef = doc(db, 'users', user.uid);\n        const userSnap = await getDoc(userRef);\n        if (!userSnap.exists()) return;\n        // Stripe決済金額をlocalStorageから取得\n        const paidAmountStr = localStorage.getItem('mcSquareLastPaidAmount');\n        const paidAmount = paidAmountStr ? parseInt(paidAmountStr, 10) : 0;\n        // ポイント付与\n        if (paidAmount > 0) {\n          const addPoint = Math.floor(paidAmount / 100);\n          const prevPoint = userSnap.data().point || 0;\n          await updateDoc(userRef, {\n            point: prevPoint + addPoint\n          });\n        }\n        // 購入履歴追加\n        if (cartItems.length > 0) {\n          const prevOrders = userSnap.data().orders || [];\n          const now = new Date();\n          const orderRecord = {\n            date: now.toISOString(),\n            items: cartItems.map(item => ({\n              managementNumber: item.managementNumber,\n              name: item.name,\n              price: item.price,\n              quantity: item.quantity\n            })),\n            total: paidAmount\n          };\n          await updateDoc(userRef, {\n            orders: [...prevOrders, orderRecord]\n          });\n        }\n        // ポイント付与・履歴追加後はlocalStorageをクリア\n        localStorage.removeItem('mcSquareLastPaidAmount');\n      } catch (e) {\n        // エラー時は何もしない\n      }\n    };\n    if (auth.currentUser) {\n      grantPointsAndSaveOrder(auth.currentUser);\n    } else {\n      const unsubscribe = onAuthStateChanged(auth, user => {\n        if (user) {\n          grantPointsAndSaveOrder(user);\n          unsubscribe();\n        }\n      });\n    }\n  }, [clearCart]);\n  return /*#__PURE__*/_jsxDEV(\"div\", {\n    style: {\n      padding: '3em 1em',\n      textAlign: 'center'\n    },\n    children: [/*#__PURE__*/_jsxDEV(\"h1\", {\n      style: {\n        color: '#E1306C',\n        marginBottom: '1em'\n      },\n      children: \"\\u3054\\u8CFC\\u5165\\u3042\\u308A\\u304C\\u3068\\u3046\\u3054\\u3056\\u3044\\u307E\\u3057\\u305F\\uFF01\"\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 72,\n      columnNumber: 7\n    }, this), /*#__PURE__*/_jsxDEV(\"p\", {\n      children: [\"\\u3054\\u6CE8\\u6587\\u304C\\u6B63\\u5E38\\u306B\\u5B8C\\u4E86\\u3057\\u307E\\u3057\\u305F\\u3002\", /*#__PURE__*/_jsxDEV(\"br\", {}, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 73,\n        columnNumber: 24\n      }, this), \"\\u3054\\u767B\\u9332\\u306E\\u30E1\\u30FC\\u30EB\\u30A2\\u30C9\\u30EC\\u30B9\\u306B\\u78BA\\u8A8D\\u30E1\\u30FC\\u30EB\\u3092\\u304A\\u9001\\u308A\\u3057\\u3066\\u3044\\u307E\\u3059\\u3002\"]\n    }, void 0, true, {\n      fileName: _jsxFileName,\n      lineNumber: 73,\n      columnNumber: 7\n    }, this), /*#__PURE__*/_jsxDEV(\"a\", {\n      href: \"/all-products\",\n      style: {\n        display: 'inline-block',\n        marginTop: '2em',\n        color: '#fff',\n        background: '#E1306C',\n        padding: '0.8em 2em',\n        borderRadius: 8,\n        textDecoration: 'none',\n        fontWeight: 700\n      },\n      children: \"\\u5546\\u54C1\\u4E00\\u89A7\\u3078\\u623B\\u308B\"\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 74,\n      columnNumber: 7\n    }, this)]\n  }, void 0, true, {\n    fileName: _jsxFileName,\n    lineNumber: 71,\n    columnNumber: 5\n  }, this);\n};\n_s(Success, \"eyO0ojMzHWrqOCiz0nTKSGgTDpA=\", false, function () {\n  return [useCart];\n});\n_c = Success;\nexport default Success;\nvar _c;\n$RefreshReg$(_c, \"Success\");","map":{"version":3,"names":["React","useEffect","useCart","getAuth","onAuthStateChanged","getFirestore","doc","getDoc","updateDoc","app","jsxDEV","_jsxDEV","db","auth","Success","_s","clearCart","cartItems","cartStr","localStorage","getItem","JSON","parse","grantPointsAndSaveOrder","user","userRef","uid","userSnap","exists","paidAmountStr","paidAmount","parseInt","addPoint","Math","floor","prevPoint","data","point","length","prevOrders","orders","now","Date","orderRecord","date","toISOString","items","map","item","managementNumber","name","price","quantity","total","removeItem","e","currentUser","unsubscribe","style","padding","textAlign","children","color","marginBottom","fileName","_jsxFileName","lineNumber","columnNumber","href","display","marginTop","background","borderRadius","textDecoration","fontWeight","_c","$RefreshReg$"],"sources":["C:/Users/what1/OneDrive/Desktop/Project/MCProject_Beta/mc-square-react/src/Success.tsx"],"sourcesContent":["import React, { useEffect } from 'react';\r\nimport { useCart } from './CartContext';\r\nimport { getAuth, onAuthStateChanged } from 'firebase/auth';\r\nimport { getFirestore, doc, getDoc, updateDoc } from 'firebase/firestore';\r\nimport { app } from './firebase';\r\n\r\nconst db = getFirestore(app);\r\nconst auth = getAuth(app);\r\n\r\nconst Success: React.FC = () => {\r\n  const { clearCart } = useCart();\r\n  useEffect(() => {\r\n    // カート内容をlocalStorageから取得\r\n    let cartItems: any[] = [];\r\n    try {\r\n      const cartStr = localStorage.getItem('mcSquareCart');\r\n      if (cartStr) cartItems = JSON.parse(cartStr);\r\n    } catch {}\r\n    clearCart();\r\n    // 決済金額からポイント付与・購入履歴追加\r\n    const grantPointsAndSaveOrder = async (user: any) => {\r\n      if (!user) return;\r\n      try {\r\n        const userRef = doc(db, 'users', user.uid);\r\n        const userSnap = await getDoc(userRef);\r\n        if (!userSnap.exists()) return;\r\n        // Stripe決済金額をlocalStorageから取得\r\n        const paidAmountStr = localStorage.getItem('mcSquareLastPaidAmount');\r\n        const paidAmount = paidAmountStr ? parseInt(paidAmountStr, 10) : 0;\r\n        // ポイント付与\r\n        if (paidAmount > 0) {\r\n          const addPoint = Math.floor(paidAmount / 100);\r\n          const prevPoint = userSnap.data().point || 0;\r\n          await updateDoc(userRef, { point: prevPoint + addPoint });\r\n        }\r\n        // 購入履歴追加\r\n        if (cartItems.length > 0) {\r\n          const prevOrders = userSnap.data().orders || [];\r\n          const now = new Date();\r\n          const orderRecord = {\r\n            date: now.toISOString(),\r\n            items: cartItems.map(item => ({\r\n              managementNumber: item.managementNumber,\r\n              name: item.name,\r\n              price: item.price,\r\n              quantity: item.quantity\r\n            })),\r\n            total: paidAmount\r\n          };\r\n          await updateDoc(userRef, { orders: [...prevOrders, orderRecord] });\r\n        }\r\n        // ポイント付与・履歴追加後はlocalStorageをクリア\r\n        localStorage.removeItem('mcSquareLastPaidAmount');\r\n      } catch (e) {\r\n        // エラー時は何もしない\r\n      }\r\n    };\r\n    if (auth.currentUser) {\r\n      grantPointsAndSaveOrder(auth.currentUser);\r\n    } else {\r\n      const unsubscribe = onAuthStateChanged(auth, user => {\r\n        if (user) {\r\n          grantPointsAndSaveOrder(user);\r\n          unsubscribe();\r\n        }\r\n      });\r\n    }\r\n  }, [clearCart]);\r\n\r\n  return (\r\n    <div style={{ padding: '3em 1em', textAlign: 'center' }}>\r\n      <h1 style={{ color: '#E1306C', marginBottom: '1em' }}>ご購入ありがとうございました！</h1>\r\n      <p>ご注文が正常に完了しました。<br />ご登録のメールアドレスに確認メールをお送りしています。</p>\r\n      <a href=\"/all-products\" style={{ display: 'inline-block', marginTop: '2em', color: '#fff', background: '#E1306C', padding: '0.8em 2em', borderRadius: 8, textDecoration: 'none', fontWeight: 700 }}>商品一覧へ戻る</a>\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default Success; "],"mappings":";;AAAA,OAAOA,KAAK,IAAIC,SAAS,QAAQ,OAAO;AACxC,SAASC,OAAO,QAAQ,eAAe;AACvC,SAASC,OAAO,EAAEC,kBAAkB,QAAQ,eAAe;AAC3D,SAASC,YAAY,EAAEC,GAAG,EAAEC,MAAM,EAAEC,SAAS,QAAQ,oBAAoB;AACzE,SAASC,GAAG,QAAQ,YAAY;AAAC,SAAAC,MAAA,IAAAC,OAAA;AAEjC,MAAMC,EAAE,GAAGP,YAAY,CAACI,GAAG,CAAC;AAC5B,MAAMI,IAAI,GAAGV,OAAO,CAACM,GAAG,CAAC;AAEzB,MAAMK,OAAiB,GAAGA,CAAA,KAAM;EAAAC,EAAA;EAC9B,MAAM;IAAEC;EAAU,CAAC,GAAGd,OAAO,CAAC,CAAC;EAC/BD,SAAS,CAAC,MAAM;IACd;IACA,IAAIgB,SAAgB,GAAG,EAAE;IACzB,IAAI;MACF,MAAMC,OAAO,GAAGC,YAAY,CAACC,OAAO,CAAC,cAAc,CAAC;MACpD,IAAIF,OAAO,EAAED,SAAS,GAAGI,IAAI,CAACC,KAAK,CAACJ,OAAO,CAAC;IAC9C,CAAC,CAAC,MAAM,CAAC;IACTF,SAAS,CAAC,CAAC;IACX;IACA,MAAMO,uBAAuB,GAAG,MAAOC,IAAS,IAAK;MACnD,IAAI,CAACA,IAAI,EAAE;MACX,IAAI;QACF,MAAMC,OAAO,GAAGnB,GAAG,CAACM,EAAE,EAAE,OAAO,EAAEY,IAAI,CAACE,GAAG,CAAC;QAC1C,MAAMC,QAAQ,GAAG,MAAMpB,MAAM,CAACkB,OAAO,CAAC;QACtC,IAAI,CAACE,QAAQ,CAACC,MAAM,CAAC,CAAC,EAAE;QACxB;QACA,MAAMC,aAAa,GAAGV,YAAY,CAACC,OAAO,CAAC,wBAAwB,CAAC;QACpE,MAAMU,UAAU,GAAGD,aAAa,GAAGE,QAAQ,CAACF,aAAa,EAAE,EAAE,CAAC,GAAG,CAAC;QAClE;QACA,IAAIC,UAAU,GAAG,CAAC,EAAE;UAClB,MAAME,QAAQ,GAAGC,IAAI,CAACC,KAAK,CAACJ,UAAU,GAAG,GAAG,CAAC;UAC7C,MAAMK,SAAS,GAAGR,QAAQ,CAACS,IAAI,CAAC,CAAC,CAACC,KAAK,IAAI,CAAC;UAC5C,MAAM7B,SAAS,CAACiB,OAAO,EAAE;YAAEY,KAAK,EAAEF,SAAS,GAAGH;UAAS,CAAC,CAAC;QAC3D;QACA;QACA,IAAIf,SAAS,CAACqB,MAAM,GAAG,CAAC,EAAE;UACxB,MAAMC,UAAU,GAAGZ,QAAQ,CAACS,IAAI,CAAC,CAAC,CAACI,MAAM,IAAI,EAAE;UAC/C,MAAMC,GAAG,GAAG,IAAIC,IAAI,CAAC,CAAC;UACtB,MAAMC,WAAW,GAAG;YAClBC,IAAI,EAAEH,GAAG,CAACI,WAAW,CAAC,CAAC;YACvBC,KAAK,EAAE7B,SAAS,CAAC8B,GAAG,CAACC,IAAI,KAAK;cAC5BC,gBAAgB,EAAED,IAAI,CAACC,gBAAgB;cACvCC,IAAI,EAAEF,IAAI,CAACE,IAAI;cACfC,KAAK,EAAEH,IAAI,CAACG,KAAK;cACjBC,QAAQ,EAAEJ,IAAI,CAACI;YACjB,CAAC,CAAC,CAAC;YACHC,KAAK,EAAEvB;UACT,CAAC;UACD,MAAMtB,SAAS,CAACiB,OAAO,EAAE;YAAEe,MAAM,EAAE,CAAC,GAAGD,UAAU,EAAEI,WAAW;UAAE,CAAC,CAAC;QACpE;QACA;QACAxB,YAAY,CAACmC,UAAU,CAAC,wBAAwB,CAAC;MACnD,CAAC,CAAC,OAAOC,CAAC,EAAE;QACV;MAAA;IAEJ,CAAC;IACD,IAAI1C,IAAI,CAAC2C,WAAW,EAAE;MACpBjC,uBAAuB,CAACV,IAAI,CAAC2C,WAAW,CAAC;IAC3C,CAAC,MAAM;MACL,MAAMC,WAAW,GAAGrD,kBAAkB,CAACS,IAAI,EAAEW,IAAI,IAAI;QACnD,IAAIA,IAAI,EAAE;UACRD,uBAAuB,CAACC,IAAI,CAAC;UAC7BiC,WAAW,CAAC,CAAC;QACf;MACF,CAAC,CAAC;IACJ;EACF,CAAC,EAAE,CAACzC,SAAS,CAAC,CAAC;EAEf,oBACEL,OAAA;IAAK+C,KAAK,EAAE;MAAEC,OAAO,EAAE,SAAS;MAAEC,SAAS,EAAE;IAAS,CAAE;IAAAC,QAAA,gBACtDlD,OAAA;MAAI+C,KAAK,EAAE;QAAEI,KAAK,EAAE,SAAS;QAAEC,YAAY,EAAE;MAAM,CAAE;MAAAF,QAAA,EAAC;IAAe;MAAAG,QAAA,EAAAC,YAAA;MAAAC,UAAA;MAAAC,YAAA;IAAA,OAAI,CAAC,eAC1ExD,OAAA;MAAAkD,QAAA,GAAG,sFAAc,eAAAlD,OAAA;QAAAqD,QAAA,EAAAC,YAAA;QAAAC,UAAA;QAAAC,YAAA;MAAA,OAAK,CAAC,sKAA2B;IAAA;MAAAH,QAAA,EAAAC,YAAA;MAAAC,UAAA;MAAAC,YAAA;IAAA,OAAG,CAAC,eACtDxD,OAAA;MAAGyD,IAAI,EAAC,eAAe;MAACV,KAAK,EAAE;QAAEW,OAAO,EAAE,cAAc;QAAEC,SAAS,EAAE,KAAK;QAAER,KAAK,EAAE,MAAM;QAAES,UAAU,EAAE,SAAS;QAAEZ,OAAO,EAAE,WAAW;QAAEa,YAAY,EAAE,CAAC;QAAEC,cAAc,EAAE,MAAM;QAAEC,UAAU,EAAE;MAAI,CAAE;MAAAb,QAAA,EAAC;IAAO;MAAAG,QAAA,EAAAC,YAAA;MAAAC,UAAA;MAAAC,YAAA;IAAA,OAAG,CAAC;EAAA;IAAAH,QAAA,EAAAC,YAAA;IAAAC,UAAA;IAAAC,YAAA;EAAA,OAC5M,CAAC;AAEV,CAAC;AAACpD,EAAA,CAnEID,OAAiB;EAAA,QACCZ,OAAO;AAAA;AAAAyE,EAAA,GADzB7D,OAAiB;AAqEvB,eAAeA,OAAO;AAAC,IAAA6D,EAAA;AAAAC,YAAA,CAAAD,EAAA","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}